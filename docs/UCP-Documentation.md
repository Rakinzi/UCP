# UCP Multi-Store System Documentation

## 1. Overview
This system is a working UCP (Universal Commerce Protocol) demo with an **Agent** that searches across multiple stores, generates an invoice, and executes an AP2 (Agent Payments Protocol) cryptographic payment flow.

- **Agent backend (FastAPI)**: orchestrates search, invoice generation, and Ed25519 signing
- **Agent frontend (SvelteKit + shadcn-svelte)**: UI for search, cart, invoice, and payment status
- **Stores (SvelteKit + TypeORM + Postgres)**: three stores with distinct UIs and product catalogs

### Goals
1. Provide a consistent UCP interface for discovery and commerce
2. Support agentic checkout via AP2 (challenge → mandate → verification)
3. Keep stores isolated with separate databases

---

## 2. Architecture

![UCP Architecture](docs/images/architecture.png)

### Components
- **Agent UI**: end-user console to find products and pay
- **Agent Backend**: search fan-out, invoice aggregation, AP2 signing
- **Stores**: each store exposes catalog search + AP2 verification endpoints

---

## 3. Deployment Topology

![Deployment Diagram](docs/images/deployment.png)

### Local Ports
- Agent UI: `http://localhost:5173`
- Agent API: `http://localhost:8000`
- Store 1: `http://localhost:4001`
- Store 2: `http://localhost:4002`
- Store 3: `http://localhost:4003`

---

## 4. UCP Discovery and Store Endpoints
Each store exposes a discovery manifest at:

```
/.well-known/ucp
```

Example response:
```
{
  "name": "Store-Alpha",
  "capabilities": ["dev.ucp.shopping.ap2"],
  "endpoints": {
    "products": "/api/products",
    "sessions": "/sessions",
    "complete": "/complete"
  }
}
```

### Product Search
```
GET /api/products?q=<term>
```

### Product Detail
```
GET /api/products/:id
```

---

## 5. Agent Search + Invoice Flow

![Search + Invoice Flow](docs/images/search-invoice-flow.png)

### Agent Endpoints
- `GET /search?q=` → aggregated results
- `POST /invoice` → per-store totals and overall invoice
- `POST /pay` → AP2 flow for each store

---

## 6. AP2 Payment Flow

![AP2 Sequence](docs/images/ap2-sequence.png)

### Steps
1. Agent requests a challenge from `/sessions`
2. Store responds with `402` and `X-UCP-Challenge`
3. Agent signs `challenge + order_total`
4. Agent submits signature as `X-UCP-Mandate` to `/complete`
5. Store verifies and returns `201` if valid

---

## 7. Databases (Per Store)
Each store uses its own Postgres DB:

- Store1 → `ucp_store1`
- Store2 → `ucp_store2`
- Store3 → `ucp_store3`

Environment variables:
```
STORE1_DATABASE_URL=postgres://postgres:postgres@host.docker.internal:5432/ucp_store1
STORE2_DATABASE_URL=postgres://postgres:postgres@host.docker.internal:5432/ucp_store2
STORE3_DATABASE_URL=postgres://postgres:postgres@host.docker.internal:5432/ucp_store3
```

---

## 8. Running the Demo

### Start services
```
docker compose up --build -d
```

### Access UIs
- Agent: `http://localhost:5173`
- Store1: `http://localhost:4001`
- Store2: `http://localhost:4002`
- Store3: `http://localhost:4003`

---

## 9. User Journey

1. Open Agent UI
2. Search for products
3. Add items to cart
4. Generate invoice
5. Pay invoice (AP2 flow)

---

## 10. Troubleshooting

- **Type errors in store apps** → run:
  ```
  bash scripts/sync-stores.sh
  ```
- **Missing products** → reseed:
  ```
  cd stores/store1 && bun run db:seed
  ```
- **Database missing** → create DBs in Postgres

---

## 11. Security Notes

- Ed25519 keys are generated by the agent backend
- Store verification uses the agent’s public key
- Each store’s challenges expire after 5 minutes

---

## 12. UI Libraries

- Store1: Skeleton
- Store2: SMUI (Material)
- Store3: Steeze UI
- Agent: shadcn-svelte

---

## 13. Appendix: Key API Calls

### Search
```
GET /search?q=hoodie
```

### Invoice
```
POST /invoice
{
  "items": [
    {"store": "http://store1-frontend:3000", "product_id": "store1-laptop", "quantity": 1}
  ]
}
```

### Pay
```
POST /pay
{
  "items": [
    {"store": "http://store1-frontend:3000", "product_id": "store1-laptop", "quantity": 1}
  ]
}
```
